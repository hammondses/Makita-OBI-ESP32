<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Makita BMS Tool</title>
    <link rel="stylesheet" href="./style.css">
    <script src="./chart.min.js"></script>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="brand">
                <span class="brand-icon">&#x26A1;</span>
                <div class="brand-text">
                    <span class="brand-name">Makita BMS</span>
                    <span class="brand-sub">ESP32 Diagnostics</span>
                </div>
            </div>
        </div>

        <div class="sidebar-status" id="statusWidget">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Connecting...</span>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-group">
                <button id="btnHome" class="nav-btn primary" data-i18n="btn_home">Home</button>
            </div>

            <div id="serviceActions" class="nav-group hidden">
                <span class="nav-label">Service</span>
                <button id="btnClearErrors" class="nav-btn danger" disabled data-i18n="btn_clear_err">Reset Errors</button>
                <button id="btnLed" class="nav-btn success" disabled data-i18n="btn_led_test">Test LED</button>
            </div>

            <div class="nav-group">
                <div class="toggle-row">
                    <span class="toggle-label" id="lblAutoDetect" data-i18n="lbl_auto_detect">Auto-detect</span>
                    <label class="switch" for="checkAuto">
                        <input type="checkbox" id="checkAuto" checked aria-labelledby="lblAutoDetect">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="toolbar">
                <div class="btn-group">
                    <button id="themeLight" class="tool-btn active">Light</button>
                    <button id="themeDark" class="tool-btn">Dark</button>
                </div>
                <div class="btn-group">
                    <button id="btnEN" class="tool-btn active">EN</button>
                    <button id="btnES" class="tool-btn">ES</button>
                </div>
            </div>
            <button id="btnSystem" class="nav-btn ghost">Settings &amp; OTA</button>
            <div class="version" data-i18n="footerText">v1.2</div>
        </div>
    </aside>

    <!-- Mobile top bar (shown only on small screens) -->
    <header class="mobile-topbar">
        <button class="hamburger" id="menuToggle">&#9776;</button>
        <span class="mobile-title">Makita BMS</span>
        <span class="mobile-status" id="mobileStatusDot"></span>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div id="limitedSupportAlert" class="alert-banner hidden"></div>

        <!-- Action bar (inline buttons) -->
        <div class="action-bar" id="actionBar">
            <button id="btnReadStatic" class="action-btn primary" data-i18n="btn_read">Read Info</button>
            <button id="btnReadDynamic" class="action-btn" disabled data-i18n="btn_dynamic">Read Voltages</button>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard hidden" id="overviewCard">
            <!-- Row 1: Info + Cells -->
            <section class="panel info-panel">
                <div class="panel-header">
                    <h2 data-i18n="section_overview">Pack Overview</h2>
                    <div id="imbalanceBadge" class="badge-pill hidden"></div>
                </div>
                <div class="kv" id="data-table"></div>
            </section>

            <section class="panel cells-panel">
                <div class="panel-header">
                    <h2>Cells</h2>
                </div>
                <div class="battery-cells" id="cellsArea"></div>
                <div class="pack-summary" id="packSummary"></div>
            </section>

            <!-- Row 2: SOH + Temps -->
            <section class="panel diag-panel">
                <div class="diag-grid">
                    <div class="diag-card">
                        <span class="diag-label" data-i18n="lbl_soh">SOH (Health)</span>
                        <div id="sohRing" class="soh-ring">--%</div>
                        <span id="sohLabel" class="diag-value">---</span>
                    </div>
                    <div class="diag-card">
                        <span class="diag-label" data-i18n="lbl_temp">Temperature</span>
                        <div class="temp-row">
                            <div class="temp-gauge"><div id="tempBar1" class="temp-bar"></div></div>
                            <div class="temp-gauge"><div id="tempBar2" class="temp-bar"></div></div>
                        </div>
                        <span id="tempValues" class="diag-value">--°C | --°C</span>
                    </div>
                </div>
            </section>

            <!-- Row 3: Imbalance HUD -->
            <section class="panel hud-panel">
                <div class="panel-header">
                    <h2 data-i18n="lbl_imbalance">Cell Imbalance (HUD)</h2>
                </div>
                <div id="imbalanceHUD" class="hud-container"></div>
            </section>

            <!-- Row 4: Chart (full width) -->
            <section class="panel chart-panel">
                <div class="panel-header">
                    <h2 data-i18n="lbl_history">Voltage History</h2>
                </div>
                <div class="chart-wrap">
                    <canvas id="historyChart"></canvas>
                </div>
            </section>

            <!-- Model Comparison -->
            <section id="modelSection" class="panel model-panel hidden">
                <div class="panel-header">
                    <h2 data-i18n="lbl_model_compare">Model Comparison</h2>
                </div>
                <div class="model-grid" id="modelComparison"></div>
            </section>

            <!-- Balancing Assistant -->
            <section id="balanceSection" class="panel balance-panel hidden">
                <div class="panel-header">
                    <h2 data-i18n="lbl_balance_title">Balancing Assistant</h2>
                </div>
                <div class="balance-assistant" id="balanceAssistant"></div>
            </section>

            <div class="alerts" id="alertsArea"></div>

            <div class="export-row">
                <button id="btnExport" class="nav-btn ghost export-btn">
                    Export Report
                </button>
            </div>

            <!-- Connected battery long-term history (inline) -->
            <section class="panel connected-history-panel hidden" id="connectedHistoryPanel">
                <div class="panel-header">
                    <h2 data-i18n="lbl_longterm_history">Long-term History</h2>
                </div>
                <div id="connectedHistoryInfo" class="history-detail-info"></div>
                <div class="chart-wrap history-chart-wrap">
                    <canvas id="connectedHistoryChart"></canvas>
                </div>
            </section>
        </div>

        <!-- Battery list (shown when no battery connected) -->
        <section class="panel battery-list-panel hidden" id="batteryListPanel">
            <div class="panel-header">
                <h2 data-i18n="lbl_history_title">Battery History</h2>
            </div>
            <table class="history-table" id="batteryListTable">
                <thead>
                    <tr>
                        <th data-i18n="hdr_model">Model</th>
                        <th data-i18n="hdr_rom">ROM ID</th>
                        <th data-i18n="hdr_cycles">Cycles</th>
                        <th data-i18n="hdr_soh">SOH</th>
                        <th data-i18n="hdr_readings">Readings</th>
                        <th data-i18n="hdr_last_seen">Last Seen</th>
                        <th data-i18n="hdr_last_v">Voltage</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="batteryListBody"></tbody>
            </table>
            <p id="historyEmpty" class="muted hidden" data-i18n="msg_no_history">No battery history recorded yet.</p>
            <div id="batteryListDetail" class="hidden">
                <div id="batteryListDetailInfo" class="history-detail-info"></div>
                <div class="chart-wrap history-chart-wrap">
                    <canvas id="batteryListChart"></canvas>
                </div>
            </div>
        </section>

        <!-- System & OTA -->
        <section class="panel system-panel hidden" id="systemSection">
            <div class="panel-header"><h2 data-i18n="lbl_system_title">System &amp; FW Update</h2></div>
            <div class="system-grid">
                <div class="ota-block">
                    <h3 data-i18n="ota_title">Firmware Update</h3>
                    <p class="muted" data-i18n="ota_desc">Upload a .bin file to update.</p>
                    <input type="file" id="otaFile" accept=".bin" class="hidden" title="Firmware file">
                    <button id="btnOta" class="nav-btn primary" data-i18n="btn_ota_select">Select File</button>
                    <div id="otaProgress" class="ota-progress hidden">
                        <div class="progress-info">
                            <span id="otaStatusMsg" data-i18n="ota_msg_uploading">Uploading...</span>
                            <span id="otaPercent">0%</span>
                        </div>
                        <div class="progress-bar"><div class="progress-fill" id="otaBar"></div></div>
                    </div>
                </div>
                <div class="wifi-block">
                    <h3 data-i18n="lbl_wifi_config">WiFi Station Mode</h3>
                    <div id="wifiStatusBox" class="wifi-status-box">
                        <div class="wifi-status-row">
                            <span data-i18n="lbl_sta_status">Station:</span>
                            <span id="staStatusText" class="wifi-val">—</span>
                        </div>
                        <div class="wifi-status-row">
                            <span data-i18n="lbl_ap_status">Access Point:</span>
                            <span id="apStatusText" class="wifi-val">—</span>
                        </div>
                        <div class="wifi-status-row">
                            <span data-i18n="lbl_clock">Clock:</span>
                            <span id="clockStatusText" class="wifi-val">—</span>
                        </div>
                    </div>
                    <div class="wifi-scan-row">
                        <select id="wifiSSID" class="wifi-select">
                            <option value="" data-i18n="lbl_select_network">-- Select Network --</option>
                        </select>
                        <button id="btnScanWifi" class="nav-btn ghost wifi-scan-btn" type="button" data-i18n="btn_scan_wifi">Scan</button>
                    </div>
                    <input type="password" id="wifiPass" placeholder="Password" data-i18n-hold="lbl_wifi_pass">
                    <button id="btnSaveWifi" class="nav-btn primary" data-i18n="btn_save_wifi">Connect</button>
                    <p class="muted" data-i18n="lbl_wifi_hint">ESP32 will restart. AP stays as fallback.</p>
                </div>
            </div>
        </section>

        <!-- Console -->
        <details class="console-panel">
            <summary id="rawTitle" data-i18n="rawTitle">System Console</summary>
            <pre id="log" class="console-output" data-i18n="log_waiting">Waiting for connection...</pre>
        </details>

        <div id="notification" class="hidden"></div>
        <div id="toast-container"></div>
    </main>

    <script src="./app.js"></script>
</body>

</html>